<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MiniClaudeCode.Avalonia.ViewModels"
             xmlns:models="using:MiniClaudeCode.Avalonia.Models"
             x:Class="MiniClaudeCode.Avalonia.Views.FileExplorerView"
             x:DataType="vm:FileExplorerViewModel">

    <Border Classes="sidebarSectionRoot"
            Background="{DynamicResource ThemeSideBarBackground}">
        <DockPanel>
            <!-- Header + Toolbar -->
            <Border DockPanel.Dock="Top"
                    Classes="sidebarSectionHeader">
                <DockPanel>
                    <TextBlock Text="Explorer"
                               Classes="sidebarSectionTitle" />

                    <!-- Toolbar buttons -->
                    <StackPanel DockPanel.Dock="Right"
                                Orientation="Horizontal"
                                Spacing="2"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Center">
                        <!-- New File -->
                        <Button Classes="panelIconAction"
                                ToolTip.Tip="New File"
                                Command="{Binding FileOperations.StartNewFileCommand}"
                                CommandParameter="{Binding SelectedNode}"
                                FontSize="12">
                            <TextBlock Text="&#x1F4C4;" FontSize="12" />
                        </Button>
                        <!-- New Folder -->
                        <Button Classes="panelIconAction"
                                ToolTip.Tip="New Folder"
                                Command="{Binding FileOperations.StartNewFolderCommand}"
                                CommandParameter="{Binding SelectedNode}"
                                FontSize="12">
                            <TextBlock Text="&#x1F4C1;" FontSize="12" />
                        </Button>
                        <!-- Refresh -->
                        <Button Classes="panelIconAction"
                                ToolTip.Tip="Refresh"
                                Command="{Binding RefreshCommand}"
                                FontSize="12">
                            <TextBlock Text="&#x21BB;" FontSize="12" />
                        </Button>
                        <!-- Collapse All -->
                        <Button Classes="panelIconAction"
                                ToolTip.Tip="Collapse All"
                                Command="{Binding CollapseAllCommand}"
                                FontSize="12">
                            <TextBlock Text="&#x2B73;" FontSize="12" />
                        </Button>
                    </StackPanel>
                </DockPanel>
            </Border>

            <!-- Inline create box (when creating new file/folder) -->
            <Border DockPanel.Dock="Top"
                    IsVisible="{Binding FileOperations.IsCreating}"
                    Classes="sidebarSectionBody"
                    Padding="8,4">
                <DockPanel>
                    <Button DockPanel.Dock="Right" Content="&#x2715;"
                        Classes="panelIconAction"
                            Command="{Binding FileOperations.CancelCreateCommand}"
                        FontSize="10" />
                    <TextBox Text="{Binding FileOperations.NewItemName, Mode=TwoWay}"
                             Watermark="Enter name"
                         FontSize="12"
                         Background="{DynamicResource ThemeInputBackground}"
                         Foreground="{DynamicResource ThemeInputForeground}"
                         BorderBrush="{DynamicResource ThemeInputFocusBorder}"
                         BorderThickness="1" Padding="4,2"
                             KeyDown="OnCreateBoxKeyDown" />
                </DockPanel>
            </Border>

            <!-- Tree View -->
            <TreeView x:Name="FileTree"
                      ItemsSource="{Binding RootNodes}"
                      SelectedItem="{Binding SelectedNode}"
                      Background="Transparent"
                      DoubleTapped="OnTreeDoubleTapped"
                      SelectionChanged="OnTreeSelectionChanged">
                <!-- CRITICAL: Bind TreeViewItem.IsExpanded to FileTreeNode.IsExpanded (two-way) -->
                <TreeView.Styles>
                    <Style Selector="TreeViewItem" x:DataType="models:FileTreeNode">
                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                    </Style>
                </TreeView.Styles>
                <TreeView.ItemTemplate>
                    <TreeDataTemplate ItemsSource="{Binding Children}" x:DataType="models:FileTreeNode">
                        <Panel>
                            <!-- Normal display -->
                            <StackPanel Orientation="Horizontal" Spacing="6" Margin="2"
                                        IsVisible="{Binding !IsRenaming}">
                                <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding Name}"
                                           FontSize="12"
                                           Foreground="{DynamicResource ThemeText}"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                            <!-- Rename mode -->
                            <StackPanel Orientation="Horizontal" Spacing="6" Margin="2"
                                        IsVisible="{Binding IsRenaming}">
                                <TextBlock Text="{Binding Icon}" FontSize="14" VerticalAlignment="Center" />
                                <TextBox Text="{Binding EditName, Mode=TwoWay}"
                                         FontSize="12"
                                         Background="{DynamicResource ThemeInputBackground}"
                                         Foreground="{DynamicResource ThemeInputForeground}"
                                         BorderBrush="{DynamicResource ThemeInputFocusBorder}" BorderThickness="1" Padding="2,0"
                                         MinWidth="120"
                                         KeyDown="OnRenameBoxKeyDown" />
                            </StackPanel>
                        </Panel>

                    </TreeDataTemplate>
                </TreeView.ItemTemplate>

                <!-- Context Menu on TreeView itself -->
                <TreeView.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="New _File"
                                  Command="{Binding FileOperations.StartNewFileCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <MenuItem Header="New F_older"
                                  Command="{Binding FileOperations.StartNewFolderCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <Separator />
                        <MenuItem Header="_Rename" InputGesture="F2"
                                  Command="{Binding FileOperations.StartRenameCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <MenuItem Header="_Delete"
                                  Command="{Binding FileOperations.DeleteNodeCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <Separator />
                        <MenuItem Header="Copy _Path"
                                  Command="{Binding FileOperations.CopyPathCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <MenuItem Header="Copy _Relative Path"
                                  Command="{Binding FileOperations.CopyRelativePathCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                        <MenuItem Header="Re_veal in Explorer"
                                  Command="{Binding FileOperations.RevealInExplorerCommand}"
                                  CommandParameter="{Binding SelectedNode}" />
                    </ContextMenu>
                </TreeView.ContextMenu>
            </TreeView>
        </DockPanel>
    </Border>
</UserControl>
