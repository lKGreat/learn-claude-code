<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:MiniClaudeCode.Avalonia.ViewModels"
        xmlns:views="using:MiniClaudeCode.Avalonia.Views"
        x:Class="MiniClaudeCode.Avalonia.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="{Binding WindowTitle}"
        Width="1400" Height="900"
        MinWidth="900" MinHeight="600"
        WindowStartupLocation="CenterScreen"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="36"
        SystemDecorations="Full"
        Classes="workbenchRoot"
        Background="{DynamicResource ThemeWorkbenchBackground}">

    <Window.KeyBindings>
        <!-- File -->
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewConversationCommand}" />
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenWorkspaceCommand}" />
        <KeyBinding Gesture="Ctrl+S" Command="{Binding Editor.SaveFileCommand}" />
        
        <!-- View -->
        <KeyBinding Gesture="Ctrl+Shift+E" Command="{Binding ActivityBar.SelectItemCommand}" CommandParameter="{Binding ActivityBar.Items[0]}" />
        <KeyBinding Gesture="Ctrl+Shift+F" Command="{Binding ActivityBar.SelectItemCommand}" CommandParameter="{Binding ActivityBar.Items[1]}" />
        <KeyBinding Gesture="Ctrl+Shift+G" Command="{Binding ActivityBar.SelectItemCommand}" CommandParameter="{Binding ActivityBar.Items[2]}" />
        <KeyBinding Gesture="Ctrl+Shift+X" Command="{Binding ActivityBar.SelectItemCommand}" CommandParameter="{Binding ActivityBar.Items[3]}" />
        <KeyBinding Gesture="Ctrl+Shift+C" Command="{Binding ActivityBar.SelectItemCommand}" CommandParameter="{Binding ActivityBar.Items[4]}" />
        <KeyBinding Gesture="Ctrl+OemTilde" Command="{Binding BottomPanel.ToggleVisibilityCommand}" />
        
        <!-- Command Palette -->
        <KeyBinding Gesture="Ctrl+Shift+P" Command="{Binding CommandPalette.ShowCommand}" />
        <KeyBinding Gesture="Ctrl+P" Command="{Binding CommandPalette.ShowQuickOpenCommand}" />

        <!-- AI Tools -->
        <KeyBinding Gesture="Ctrl+Shift+I" Command="{Binding OpenComposerCommand}" />

        <!-- Other -->
        <KeyBinding Gesture="Escape" Command="{Binding CancelOperationCommand}" />
    </Window.KeyBindings>

    <!-- Use Panel as root to allow overlay dialogs -->
    <Panel>
        <!-- Main VS Code-style layout -->
        <DockPanel>

            <!-- ============================================================ -->
            <!-- Row 1: Custom Title Bar (replaces OS title bar)              -->
            <!-- ============================================================ -->
            <Border DockPanel.Dock="Top"
                    Classes="workbenchTitleBar"
                    Height="36"
                    Background="{DynamicResource ThemeTitleBarBackground}">
                <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">

                    <!-- Left: App Logo -->
                    <Border Grid.Column="0"
                            Background="#89B4FA"
                            CornerRadius="4"
                            Width="20" Height="20"
                            Margin="8,0,8,0"
                            VerticalAlignment="Center">
                        <TextBlock Text="M"
                                   FontSize="11"
                                   FontWeight="Bold"
                                   Foreground="#11111B"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center" />
                    </Border>

                    <!-- Center-Left: Navigation Buttons -->
                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="2"
                                VerticalAlignment="Center"
                                Margin="0,0,8,0">
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Go Back"
                                Width="28" Height="28">
                            <TextBlock Text="&#x2190;" FontSize="16" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Go Forward"
                                Width="28" Height="28">
                            <TextBlock Text="&#x2192;" FontSize="16" />
                        </Button>
                    </StackPanel>

                    <!-- Center: Search/Command Input Box -->
                    <TextBox Grid.Column="2"
                             Text="{Binding WindowTitle}"
                             IsReadOnly="True"
                             Background="{DynamicResource ThemeInputBackground}"
                             BorderBrush="{DynamicResource ThemeInputBorder}"
                             BorderThickness="1"
                             CornerRadius="4"
                             Padding="8,4"
                             FontSize="12"
                             Foreground="{DynamicResource ThemeMutedForeground}"
                             MaxWidth="400"
                             VerticalAlignment="Center"
                             HorizontalAlignment="Center" />

                    <!-- Right Toolbar: Layout/Split/Fullscreen/Settings/Theme/More -->
                    <StackPanel Grid.Column="3"
                                Orientation="Horizontal"
                                Spacing="2"
                                VerticalAlignment="Center"
                                Margin="8,0">
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Customize Layout"
                                Width="28" Height="28">
                            <TextBlock Text="&#x2630;" FontSize="14" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Split Editor"
                                Width="28" Height="28">
                            <TextBlock Text="&#x25A7;" FontSize="14" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Toggle Fullscreen"
                                Width="28" Height="28">
                            <TextBlock Text="&#x26F6;" FontSize="14" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Settings"
                                Width="28" Height="28">
                            <TextBlock Text="&#x2699;" FontSize="14" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="Toggle Theme"
                                Width="28" Height="28">
                            <TextBlock Text="&#x263D;" FontSize="14" />
                        </Button>
                        <Button Classes="titleBarIconButton"
                                ToolTip.Tip="More Actions"
                                Width="28" Height="28">
                            <TextBlock Text="&#x22EF;" FontSize="16" />
                        </Button>
                    </StackPanel>

                    <!-- Far Right: Window Control Buttons -->
                    <StackPanel Grid.Column="4"
                                Orientation="Horizontal"
                                VerticalAlignment="Stretch">
                        <!-- Minimize -->
                        <Button Classes="windowControl"
                                Click="OnMinimizeClick"
                                ToolTip.Tip="Minimize">
                            <TextBlock Text="&#x2014;"
                                       FontSize="12"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                        </Button>

                        <!-- Maximize / Restore -->
                        <Button Classes="windowControl"
                                x:Name="MaxRestoreButton"
                                Click="OnMaximizeRestoreClick"
                                ToolTip.Tip="Maximize">
                            <TextBlock x:Name="MaxRestoreIcon"
                                       Text="&#x25A1;"
                                       FontSize="14"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                        </Button>

                        <!-- Close -->
                        <Button Classes="windowControlClose"
                                Click="OnCloseClick"
                                ToolTip.Tip="Close">
                            <TextBlock Text="&#x2715;"
                                       FontSize="12"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ============================================================ -->
            <!-- Row 2: Menu Bar (separate row below title bar)               -->
            <!-- ============================================================ -->
            <Border DockPanel.Dock="Top"
                    Classes="menuBarRow">
                <Menu Background="Transparent"
                      VerticalAlignment="Center"
                      Margin="8,0,0,0">
                    <MenuItem Header="_File">
                        <MenuItem Header="_New Conversation" InputGesture="Ctrl+N" Command="{Binding NewConversationCommand}" />
                        <Separator />
                        <MenuItem Header="_Open File..." InputGesture="Ctrl+Shift+O" Command="{Binding OpenFileDialogCommand}" />
                        <MenuItem Header="Open _Folder..." InputGesture="Ctrl+O" Command="{Binding OpenWorkspaceCommand}" />
                        <MenuItem Header="Recent _Workspaces" ItemsSource="{Binding RecentWorkspaceMenuItems}">
                            <MenuItem.ItemContainerTheme>
                                <ControlTheme TargetType="MenuItem" x:DataType="vm:RecentWorkspaceMenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                    <Setter Property="Header" Value="{Binding DisplayName}" />
                                    <Setter Property="Command" Value="{Binding OpenCommand}" />
                                </ControlTheme>
                            </MenuItem.ItemContainerTheme>
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="_Save" InputGesture="Ctrl+S" Command="{Binding Editor.SaveFileCommand}" />
                        <MenuItem Header="Save _As..." InputGesture="Ctrl+Shift+S" Command="{Binding SaveFileAsCommand}" />
                        <Separator />
                        <MenuItem Header="_Close Editor" InputGesture="Ctrl+W" Command="{Binding CloseActiveEditorCommand}" />
                        <Separator />
                        <MenuItem Header="E_xit" Command="{Binding ExitAppCommand}" />
                    </MenuItem>
                    <MenuItem Header="_Edit">
                        <MenuItem Header="_Find" InputGesture="Ctrl+F" Command="{Binding ShowFindCommand}" />
                        <MenuItem Header="_Replace" InputGesture="Ctrl+H" Command="{Binding ShowReplaceCommand}" />
                        <Separator />
                        <MenuItem Header="Find in _Files" InputGesture="Ctrl+Shift+F" />
                    </MenuItem>
                    <MenuItem Header="_Selection">
                        <MenuItem Header="Select _All" InputGesture="Ctrl+A" />
                        <MenuItem Header="Expand Selection" InputGesture="Shift+Alt+Right" />
                        <MenuItem Header="Shrink Selection" InputGesture="Shift+Alt+Left" />
                    </MenuItem>
                    <MenuItem Header="_View">
                        <MenuItem Header="_Command Palette..." InputGesture="Ctrl+Shift+P" Command="{Binding CommandPalette.ShowCommand}" />
                        <MenuItem Header="_Quick Open File..." InputGesture="Ctrl+P" Command="{Binding CommandPalette.ShowQuickOpenCommand}" />
                        <Separator />
                        <MenuItem Header="_Explorer" InputGesture="Ctrl+Shift+E" />
                        <MenuItem Header="_Search" InputGesture="Ctrl+Shift+F" />
                        <MenuItem Header="Source _Control" InputGesture="Ctrl+Shift+G" />
                        <MenuItem Header="E_xtensions" InputGesture="Ctrl+Shift+X" />
                        <MenuItem Header="_AI Chat" InputGesture="Ctrl+Shift+C" />
                        <Separator />
                        <MenuItem Header="_Terminal" InputGesture="Ctrl+OemTilde" Command="{Binding BottomPanel.ToggleVisibilityCommand}" />
                        <MenuItem Header="_Plan Mode" Command="{Binding TogglePlanModeCommand}" />
                        <Separator />
                        <MenuItem Header="Color Theme">
                            <MenuItem Header="Catppuccin Mocha (Dark)" Command="{Binding SwitchThemeCommand}" CommandParameter="catppuccin-mocha" />
                            <MenuItem Header="Catppuccin Latte (Light)" Command="{Binding SwitchThemeCommand}" CommandParameter="catppuccin-latte" />
                            <MenuItem Header="High Contrast" Command="{Binding SwitchThemeCommand}" CommandParameter="high-contrast" />
                        </MenuItem>
                        <Separator />
                        <MenuItem Header="Toggle _Minimap" Command="{Binding ToggleMinimapCommand}" />
                        <MenuItem Header="Toggle Code _Folding" Command="{Binding ToggleFoldingCommand}" />
                        <MenuItem Header="Toggle _Indent Guides" Command="{Binding ToggleIndentGuidesCommand}" />
                    </MenuItem>
                    <MenuItem Header="_Go">
                        <MenuItem Header="Go to _File..." InputGesture="Ctrl+P" Command="{Binding CommandPalette.ShowQuickOpenCommand}" />
                        <MenuItem Header="Go to _Line..." />
                    </MenuItem>
                    <MenuItem Header="_Terminal">
                        <MenuItem Header="_New Terminal" Command="{Binding BottomPanel.ToggleVisibilityCommand}" />
                    </MenuItem>
                    <MenuItem Header="_Help">
                        <MenuItem Header="_About" Click="OnAboutClick" />
                    </MenuItem>
                </Menu>
            </Border>

            <!-- ============================================================ -->
            <!-- Bottom: Status Bar                                           -->
            <!-- ============================================================ -->
            <views:StatusBarView DockPanel.Dock="Bottom"
                                  DataContext="{Binding StatusBar}" />

            <!-- ============================================================ -->
            <!-- Main content area: ActivityBar | Sidebar | Content           -->
            <!-- ============================================================ -->
            <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                
                <!-- Column 0: Activity Bar (48px, left-most icon strip) -->
                <views:ActivityBarView Grid.Column="0"
                                        DataContext="{Binding ActivityBar}" />

                <!-- Column 1: Sidebar (collapsible, 250px) -->
                <Border Grid.Column="1"
                        Classes="workbenchSidebar"
                        Width="{Binding Sidebar.Width}"
                        MinWidth="{Binding Sidebar.MinWidth}"
                        MaxWidth="{Binding Sidebar.MaxWidth}"
                        IsVisible="{Binding Sidebar.IsVisible}">
                    <Grid ColumnDefinitions="*,5">
                        <views:SidebarView Grid.Column="0" />
                        
                        <GridSplitter Grid.Column="1"
                                      ResizeDirection="Columns"
                                      Background="{DynamicResource ThemePanelBorder}" />
                    </Grid>
                </Border>

                <!-- Column 2: Editor / AI Chat + Bottom Panel -->
                <DockPanel Grid.Column="2">

                    <!-- Bottom Panel (Terminal, Problems, etc.) - collapsible -->
                    <Border DockPanel.Dock="Bottom"
                            Classes="workbenchPanel"
                            Height="{Binding BottomPanel.Height}"
                            IsVisible="{Binding BottomPanel.IsVisible}">
                        <Grid RowDefinitions="5,*">
                            <GridSplitter Grid.Row="0"
                                          ResizeDirection="Rows"
                                          Background="{DynamicResource ThemePanelBorder}"
                                          HorizontalAlignment="Stretch" />
                            
                            <views:BottomPanelView Grid.Row="1" />
                        </Grid>
                    </Border>

                    <!-- Main Content: Welcome Page (when no files) or Editor (when files open) -->
                    <Panel>
                        <!-- ================================================ -->
                        <!-- Welcome Page (shown when no editor files open)   -->
                        <!-- ================================================ -->
                        <views:WelcomePage IsVisible="{Binding !Editor.HasOpenFiles}"
                                           DataContext="{Binding}" />

                        <!-- ================================================ -->
                        <!-- Editor (shown when files are open)               -->
                        <!-- ================================================ -->
                        <DockPanel IsVisible="{Binding Editor.HasOpenFiles}">
                            <!-- Input View at bottom of editor area for quick AI access -->
                            <views:InputView DockPanel.Dock="Bottom" />
                            
                            <Panel>
                                <!-- Editor -->
                                <views:EditorView DataContext="{Binding Editor}" />
                                
                                <!-- Diff Editor overlay -->
                                <views:DiffEditorView DataContext="{Binding DiffEditor}" />
                            </Panel>
                        </DockPanel>
                    </Panel>
                </DockPanel>

                <!-- Column 3: Auxiliary Bar + Composer Panel (right sidebar) -->
                <Grid Grid.Column="3">
                    <!-- Auxiliary Bar (toggled with Ctrl+Alt+B) -->
                    <Border Classes="workbenchSidebar"
                            Width="{Binding AuxiliaryBar.Width}"
                            MinWidth="{Binding AuxiliaryBar.MinWidth}"
                            MaxWidth="{Binding AuxiliaryBar.MaxWidth}"
                            IsVisible="{Binding AuxiliaryBar.IsVisible}"
                            Background="{DynamicResource ThemeSideBarBackground}"
                            BorderBrush="{DynamicResource ThemeSideBarBorder}"
                            BorderThickness="1,0,0,0">
                        <Grid ColumnDefinitions="5,*">
                            <GridSplitter Grid.Column="0"
                                          ResizeDirection="Columns"
                                          Background="{DynamicResource ThemePanelBorder}" />

                            <DockPanel Grid.Column="1">
                                <Border DockPanel.Dock="Top"
                                        Classes="sidebarSectionHeader"
                                        Padding="8,6">
                                    <DockPanel>
                                        <TextBlock Text="Secondary Sidebar"
                                                   Classes="sidebarSectionTitle" />
                                        <Button Classes="panelIconAction"
                                                DockPanel.Dock="Right"
                                                Content="&#x2715;"
                                                Command="{Binding AuxiliaryBar.ToggleCommand}"
                                                FontSize="10" Padding="4,2"
                                                HorizontalAlignment="Right" />
                                    </DockPanel>
                                </Border>
                                <views:ChatView DataContext="{Binding Chat}" />
                            </DockPanel>
                        </Grid>
                    </Border>

                    <!-- Composer Panel (overlay when visible) -->
                    <views:ComposerPanelView DataContext="{Binding ComposerPanel}"
                                              IsVisible="{Binding IsVisible}"
                                              IsHitTestVisible="{Binding IsVisible}"
                                              HorizontalAlignment="Right" />
                </Grid>
            </Grid>
        </DockPanel>

        <!-- Overlay: Command Palette -->
        <views:CommandPaletteView DataContext="{Binding CommandPalette}" />

        <!-- Overlay: Notification Toasts -->
        <views:NotificationToastView DataContext="{Binding Notification}" />

        <!-- Overlay: Setup Wizard Dialog -->
        <views:SetupWizardDialog DataContext="{Binding SetupWizard}"
                                  IsVisible="{Binding IsVisible}"
                                  IsHitTestVisible="{Binding IsVisible}" />

        <!-- Overlay: Question Dialog -->
        <views:QuestionDialog DataContext="{Binding QuestionDialog}"
                               IsVisible="{Binding IsVisible}"
                               IsHitTestVisible="{Binding IsVisible}" />
    </Panel>
</Window>
